# StreamFlow API Reference

**Version**: 1.0.0-beta  
**Base URL**: `https://your-domain.vercel.app`  
**Last Updated**: 2025-01-01

---

## üîê AUTHENTICATION

### Client Authentication
- **Method**: Cookie-based (`ws_user`)
- **Login**: `POST /api/auth/login`
- **Register**: `POST /api/auth/register`
- **Logout**: `POST /api/auth/logout`

### Provider Authentication
- **Method**: Cookie-based (`ws_provider`)
- **Login**: `POST /api/provider/auth/login`
- **Logout**: `POST /api/provider/auth/logout`
- **2FA**: TOTP required for recovery mode

### Customer Authentication
- **Method**: Bearer token
- **Header**: `Authorization: Bearer <token>`
- **Token**: Generated by service provider

---

## üìã CLIENT APIs

### Authentication

#### POST /api/auth/register
Register new organization and owner account.

**Request**:
```json
{
  "email": "owner@example.com",
  "password": "secure-password",
  "orgName": "My Company"
}
```

**Response** (201):
```json
{
  "user": {
    "id": "user_123",
    "email": "owner@example.com",
    "role": "OWNER"
  },
  "org": {
    "id": "org_123",
    "name": "My Company"
  }
}
```

#### POST /api/auth/login
Login to client portal.

**Request**:
```json
{
  "email": "user@example.com",
  "password": "password"
}
```

**Response** (200):
```json
{
  "user": {
    "id": "user_123",
    "email": "user@example.com",
    "role": "OWNER",
    "orgId": "org_123"
  }
}
```

### AI Power Management

#### GET /api/tenant/ai/power/profile
Get AI power profile for organization.

**Response** (200):
```json
{
  "id": "prof_123",
  "orgId": "org_123",
  "defaultPower": "STANDARD",
  "allowEmployeeMax": false,
  "overrides": {}
}
```

#### POST /api/tenant/ai/power/override
Set power level override for specific feature.

**Request**:
```json
{
  "featureKey": "inbox_agent",
  "powerLevel": "MAX"
}
```

### Credit Management

#### GET /api/tenant/credits/balance
Get current credit balance.

**Response** (200):
```json
{
  "balance": 10000,
  "currency": "cents"
}
```

#### POST /api/tenant/credits/purchase
Purchase AI credits.

**Request**:
```json
{
  "amountCents": 5000,
  "paymentMethod": "stripe"
}
```

### AI Task Execution

#### POST /api/tenant/ai/tasks/execute
Execute AI task.

**Request**:
```json
{
  "agentType": "inbox",
  "actionType": "triage",
  "inputData": {
    "message": "Customer inquiry..."
  }
}
```

**Response** (200):
```json
{
  "taskId": "task_123",
  "result": {
    "category": "support",
    "priority": "high"
  },
  "costCents": 50,
  "tokensUsed": 500
}
```

**Response** (402 - Insufficient Credits):
```json
{
  "error": "INSUFFICIENT_CREDITS",
  "message": "Not enough credits",
  "details": {
    "required": 50,
    "available": 10
  }
}
```

### Job Tickets

#### POST /api/tenant/jobs/tickets
Create job ticket.

**Request**:
```json
{
  "customerId": "cust_123",
  "serviceType": "Installation",
  "location": {
    "address": "123 Main St",
    "lat": 40.7128,
    "lng": -74.0060
  },
  "scheduledAt": "2025-01-15T10:00:00Z"
}
```

#### GET /api/tenant/jobs/tickets
List job tickets.

**Query Parameters**:
- `status`: Filter by status
- `customerId`: Filter by customer
- `limit`: Number of results (default: 20)

### Adoption Discounts

#### GET /api/tenant/adoption/discount
Get current adoption discount.

**Response** (200):
```json
{
  "adoptionRate": 65.5,
  "discountPercent": 60,
  "nextTierAt": 70,
  "maxDiscount": false
}
```

---

## üîß PROVIDER APIs

### Authentication

#### POST /api/provider/auth/login
Provider login with 2FA.

**Request**:
```json
{
  "email": "ops@yourdomain.com",
  "password": "secure-password",
  "totpCode": "123456"
}
```

**Response** (200):
```json
{
  "email": "ops@yourdomain.com",
  "mode": "normal"
}
```

**Response** (200 - Recovery Mode):
```json
{
  "email": "ops@yourdomain.com",
  "mode": "recovery",
  "warning": "Database unavailable - limited functionality"
}
```

### Domain Management

#### GET /api/provider/domains
List all custom domains.

**Response** (200):
```json
{
  "domains": [
    {
      "id": "dom_123",
      "orgId": "org_123",
      "domain": "company.example.com",
      "verified": true,
      "active": true
    }
  ]
}
```

### Profitability Analytics

#### GET /api/provider/profitability/dashboard
Get profitability dashboard.

**Query Parameters**:
- `startDate`: Start date (ISO 8601)
- `endDate`: End date (ISO 8601)

**Response** (200):
```json
{
  "totalRevenue": 50000,
  "totalCosts": 15000,
  "profit": 35000,
  "profitMargin": 70,
  "tenants": [
    {
      "orgId": "org_123",
      "orgName": "Company A",
      "revenue": 10000,
      "costs": 3000,
      "profit": 7000
    }
  ]
}
```

### AI Evaluation

#### POST /api/provider/ai/evaluations/golden-dataset
Create golden dataset entry.

**Request**:
```json
{
  "agentType": "inbox",
  "actionType": "triage",
  "input": "Customer inquiry...",
  "expectedOutput": "category: support, priority: high"
}
```

#### GET /api/provider/ai/evaluations/ab-test
Get A/B test results.

**Response** (200):
```json
{
  "tests": [
    {
      "modelA": "gpt-4",
      "modelB": "gpt-3.5-turbo",
      "metricsA": {
        "precision": 0.95,
        "recall": 0.92,
        "f1": 0.93
      },
      "metricsB": {
        "precision": 0.88,
        "recall": 0.85,
        "f1": 0.86
      }
    }
  ]
}
```

### Monitoring

#### GET /api/provider/monitoring/metrics
Get system metrics.

**Response** (200):
```json
{
  "totalMetrics": 1000,
  "totalPerformanceMetrics": 500,
  "totalErrors": 10,
  "recentMetrics": [...],
  "recentPerformance": [...],
  "recentErrors": [...]
}
```

#### GET /api/provider/queue/stats
Get queue statistics.

**Response** (200):
```json
{
  "pending": 5,
  "processing": 2,
  "completed": 100,
  "failed": 3
}
```

---

## üë• CUSTOMER APIs

### Dashboard

#### GET /api/customer/dashboard
Get customer dashboard.

**Headers**:
```
Authorization: Bearer <customer_token>
```

**Response** (200):
```json
{
  "customer": {
    "id": "cust_123",
    "name": "John Doe",
    "email": "john@example.com",
    "phone": "555-1234",
    "company": "Acme Inc",
    "orgName": "Service Provider"
  },
  "recentJobs": [...],
  "upcomingJobs": [...],
  "stats": {
    "totalJobs": 10,
    "completedJobs": 8
  }
}
```

### Appointments

#### POST /api/customer/appointments/request
Request appointment.

**Headers**:
```
Authorization: Bearer <customer_token>
```

**Request**:
```json
{
  "serviceType": "Installation",
  "preferredDate": "2025-01-15T10:00:00Z",
  "notes": "Please call before arriving"
}
```

**Response** (201):
```json
{
  "id": "job_123",
  "status": "pending",
  "serviceType": "Installation",
  "scheduledAt": "2025-01-15T10:00:00Z"
}
```

### Feedback

#### POST /api/customer/feedback
Submit feedback.

**Headers**:
```
Authorization: Bearer <customer_token>
```

**Request**:
```json
{
  "rating": 5,
  "category": "service",
  "comment": "Excellent service!"
}
```

**Response** (200):
```json
{
  "success": true
}
```

---

## üè• SYSTEM APIs

### Health Check

#### GET /api/health
Get system health status.

**Response** (200 - Healthy):
```json
{
  "status": "healthy",
  "timestamp": "2025-01-01T00:00:00Z",
  "checks": {
    "database": true,
    "cache": true,
    "queue": true
  },
  "stats": {
    "cache": {
      "hits": 1000,
      "misses": 100,
      "hitRate": 0.91
    },
    "queue": {
      "pending": 5,
      "processing": 2,
      "completed": 100,
      "failed": 3
    }
  }
}
```

**Response** (503 - Degraded):
```json
{
  "status": "degraded",
  "timestamp": "2025-01-01T00:00:00Z",
  "checks": {
    "database": false,
    "cache": true,
    "queue": true
  }
}
```

---

## üîí ERROR RESPONSES

### Standard Error Format
```json
{
  "error": "ERROR_CODE",
  "message": "Human-readable message",
  "details": {}
}
```

### Common Error Codes
- `UNAUTHORIZED` (401) - Not authenticated
- `FORBIDDEN` (403) - Not authorized
- `NOT_FOUND` (404) - Resource not found
- `VALIDATION_ERROR` (422) - Invalid input
- `INSUFFICIENT_CREDITS` (402) - Not enough credits
- `RATE_LIMIT_EXCEEDED` (429) - Too many requests
- `INTERNAL` (500) - Server error

---

## üìä RATE LIMITS

- **Auth endpoints**: 5 requests / 15 minutes
- **API endpoints**: 60 requests / minute
- **AI endpoints**: 10 requests / minute
- **Import endpoints**: 10 requests / hour
- **General**: 100 requests / minute

---

## üîê SECURITY

### Headers
- `X-Request-ID`: Request tracking
- `X-Idempotency-Key`: Idempotent mutations (24-hour cache)

### Cookies
- `ws_user`: Client session (HTTP-only, Secure)
- `ws_provider`: Provider session (HTTP-only, Secure)

### HMAC Signatures
Provider API calls should include HMAC signature for verification.

---

## üìö ADDITIONAL RESOURCES

- **System Overview**: `docs/COMPLETE_SYSTEM_OVERVIEW.md`
- **Deployment Guide**: `docs/DEPLOYMENT_GUIDE.md`
- **Code Review**: `ops/CODE_REVIEW_AND_ENHANCEMENTS.md`

---

**For support, contact your StreamFlow administrator.**

