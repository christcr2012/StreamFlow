generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Org {
  id           String   @id @default(cuid())
  name         String
  featureFlags Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // AI Cost Control & Monetization - PROVIDER MODEL
  aiMonthlyBudgetCents Int      @default(5000)  // $50 provider cost limit  
  aiCreditBalance     Int      @default(1000)   // 1k credits = $50 worth (1 credit = $0.05 client-facing)
  aiPlan              AiPlan   @default(BASE)   // Client subscription tier
  aiAlerts            Json     @default("{}")   // Usage alert thresholds

  // Stripe Subscription Management
  stripeCustomerId      String?   // Stripe customer ID for billing
  stripeSubscriptionId  String?   // Current active subscription ID
  subscriptionStatus    String?   // active, past_due, canceled, etc
  subscriptionStartDate DateTime? // When subscription started
  subscriptionEndDate   DateTime? // When subscription ends/ended

  // Back-relations
  auditLogs     AuditLog[]
  ledger        BillingLedger[]
  customers     Customer[]
  invoices      Invoice[]
  jobs          Job[]
  leads         Lead[]
  opportunities Opportunity[]
  payments      Payment[]
  referrals     Referral[]
  rfps          Rfp[]
  users         User[]
  rbacRoles     RbacRole[]      @relation("OrgRbacRoles")
  rbacUserRoles RbacUserRole[]  @relation("OrgRbacUserRoles")
  leadInvoices  LeadInvoice[]   @relation("OrgLeadInvoices")
  pricingPlan   PricingPlan?    @relation("OrgPricingPlan")
  aiUsageEvents AiUsageEvent[]  @relation("OrgAiUsageEvents")
  aiMonthlySummaries AiMonthlySummary[] @relation("OrgAiMonthlySummaries")
  leadActivities LeadActivity[]  @relation("OrgLeadActivities")
  leadTasks     LeadTask[]      @relation("OrgLeadTasks")
  
  // Multi-Portal Business OS Relations
  employeeProfiles EmployeeProfile[] @relation("OrgEmployeeProfiles")
  workOrders      WorkOrder[]       @relation("OrgWorkOrders")
  jobSites        JobSite[]         @relation("OrgJobSites")
  jobAssignments  JobAssignment[]   @relation("OrgJobAssignments")
  timesheets      TimesheetEntry[]  @relation("OrgTimesheets")
  jobChecklists   JobChecklistItem[] @relation("OrgJobChecklists")
  issueReports    IssueReport[]     @relation("OrgIssueReports")
  mediaAssets     MediaAsset[]      @relation("OrgMediaAssets")
  trainingModules TrainingModule[]  @relation("OrgTrainingModules")
  trainingCompletions TrainingCompletion[] @relation("OrgTrainingCompletions")

  /// brandConfig stores white-label brand settings such as name, colors, and logo URL.
  /// It is JSON to allow arbitrary keys like { name: "Mountain Vista", color: "#123456", logoUrl: "https://..." }
  brandConfig Json? @default("{}")

  /// settingsJson stores arbitrary organization-level settings.  This can be used
  /// by owners to configure API keys or other preferences needed at runtime.
  settingsJson Json? @default("{}")
}

model User {
  id                 String   @id @default(cuid())
  orgId              String
  email              String   @unique
  name               String?
  role               Role     @default(STAFF)
  passwordHash       String?  @db.VarChar(255)
  mustChangePassword Boolean  @default(false)
  status             String   @default("active")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  org             Org            @relation(fields: [orgId], references: [id])
  rbacUserRoles   RbacUserRole[] @relation("UserRbacUserRoles")
  leadActivities  LeadActivity[] @relation("UserLeadActivities")
  assignedTasks   LeadTask[]     @relation("AssignedLeadTasks")
  createdTasks    LeadTask[]     @relation("CreatedLeadTasks")
  
  // Employee Portal Relations
  employeeProfile EmployeeProfile? @relation("UserEmployeeProfile")
  
  @@unique([orgId, id])  // Multi-tenant isolation
}

model Lead {
  id              String     @id @default(cuid())
  orgId           String
  publicId        String     @unique
  sourceType      LeadSource
  identityHash    String
  company         String?
  contactName     String?
  email           String?
  phoneE164       String?
  website         String?
  serviceCode     String?
  zip             String?
  enrichmentJson  Json       @default("{}")
  aiScore         Int        @default(0)
  scoreFactors    Json       @default("{}")
  /// systemGenerated: true if lead came from SAM/automated import
  systemGenerated Boolean    @default(false)
  /// convertedAt: timestamp when lead was converted (if status changes to converted)
  convertedAt     DateTime?
  /// rfp: raw RFP metadata from SAM.gov
  rfp             Json?
  /// Status of the lead. Stored as an enum rather than string for consistency.
  status          LeadStatus @default(NEW)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  city            String?
  notes           String?
  sourceDetail    String?
  state           String?
  postalCode      String?    @db.VarChar(20)
  address         String?
  addressLine1    String?
  addressLine2    String?
  country         String?

  org             Org               @relation(fields: [orgId], references: [id])
  LeadInvoiceLine LeadInvoiceLine[]
  activities      LeadActivity[]    @relation("LeadActivities")
  tasks           LeadTask[]        @relation("LeadTasks")
  
  @@unique([orgId, id])  // Multi-tenant isolation
  @@index([orgId, createdAt])
  @@index([orgId, convertedAt])
  @@index([orgId, status])
  @@index([orgId, sourceType])
  @@index([orgId, identityHash])
}

model Customer {
  id           String   @id @default(cuid())
  orgId        String
  publicId     String   @unique
  company      String?
  primaryName  String?
  primaryEmail String?
  primaryPhone String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  org           Org           @relation(fields: [orgId], references: [id])
  invoices      Invoice[]
  jobs          Job[]
  workOrders    WorkOrder[]   @relation("CustomerWorkOrders")
  opportunities Opportunity[]
  
  @@unique([orgId, id])  // Multi-tenant isolation
}

model Opportunity {
  id             String    @id @default(cuid())
  orgId          String
  customerId     String
  valueType      ValueType @default(RELATIONSHIP)
  estValue       Decimal?  @db.Decimal(12, 2)
  stage          String    @default("new")
  ownerId        String?
  sourceLeadId   String?
  classification Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  customer Customer @relation(fields: [orgId, customerId], references: [orgId, id])
  org      Org      @relation(fields: [orgId], references: [id])
}

model Invoice {
  id         String   @id @default(cuid())
  orgId      String
  customerId String?
  amount     Decimal  @db.Decimal(12, 2)
  status     String   @default("draft")
  issuedAt   DateTime @default(now())
  items      Json     @default("[]")

  customer Customer? @relation(fields: [orgId, customerId], references: [orgId, id])
  org      Org       @relation(fields: [orgId], references: [id])
  payments Payment[]
  
  @@unique([orgId, id])  // Multi-tenant isolation
}

model Payment {
  id         String   @id @default(cuid())
  orgId      String
  invoiceId  String?
  amount     Decimal  @db.Decimal(12, 2)
  method     String   @default("stripe")
  receivedAt DateTime @default(now())
  reference  String?

  invoice Invoice? @relation(fields: [orgId, invoiceId], references: [orgId, id])
  org     Org      @relation(fields: [orgId], references: [id])
  
  @@unique([orgId, id])  // Multi-tenant isolation
}

model Rfp {
  id          String    @id @default(cuid())
  orgId       String
  publicId    String    @unique
  sourceSite  String
  title       String
  dueDate     DateTime?
  docs        Json      @default("[]")
  aiBidFit    Int?
  aiPriceHint Json      @default("{}")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  jobs Job[]
  org  Org   @relation(fields: [orgId], references: [id])
  
  @@unique([orgId, id])  // Multi-tenant isolation
}

model Job {
  id         String   @id @default(cuid())
  orgId      String
  customerId String?
  rfpId      String?
  status     String   @default("planned")
  schedule   Json     @default("{}")
  assignedTo String?
  checklist  Json     @default("[]")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer? @relation(fields: [orgId, customerId], references: [orgId, id])
  org      Org       @relation(fields: [orgId], references: [id])
  rfp      Rfp?      @relation(fields: [orgId, rfpId], references: [orgId, id])
  
  @@unique([orgId, id])  // Multi-tenant isolation
}

model Referral {
  id            String    @id @default(cuid())
  orgId         String
  employeeId    String?
  referredName  String
  referredEmail String?
  referredPhone String?
  status        String    @default("new")
  convertedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  org Org @relation(fields: [orgId], references: [id])
}

model BillingLedger {
  id        String     @id @default(cuid())
  orgId     String
  type      LedgerType
  amount    Decimal    @db.Decimal(12, 2)
  meta      Json       @default("{}")
  createdAt DateTime   @default(now())

  org Org @relation(fields: [orgId], references: [id])

  @@index([orgId, type])
}

/// LeadInvoice represents a monthly invoice for converted leads. This is separate from the
/// existing Invoice model used for customers/jobs. It aggregates lead conversions and
/// includes metadata to support billing and optional Stripe integration.
model LeadInvoice {
  id              String   @id @default(cuid())
  orgId           String   // Made required for multi-tenant isolation
  org             Org      @relation("OrgLeadInvoices", fields: [orgId], references: [id])
  number          String   @unique
  periodFrom      DateTime
  periodTo        DateTime
  status          String // "draft" | "open" | "paid" | "void" | "uncollectible"
  subtotalCents   Int
  taxCents        Int      @default(0)
  totalCents      Int
  currency        String   @default("usd")
  stripeInvoiceId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  /// Number of leads billed on this invoice (to support flat-per-lead billing)
  leadCount       Int      @default(0)

  lines LeadInvoiceLine[]
  
  @@unique([orgId, id])  // Multi-tenant isolation
}

/// LeadInvoiceLine represents an individual line item on a LeadInvoice. Each line is typically
/// associated with a converted lead, but generic fee/credit lines are also supported.
model LeadInvoiceLine {
  id        String      @id @default(cuid())
  orgId     String      // Added for multi-tenant isolation
  invoiceId String
  invoice   LeadInvoice @relation(fields: [orgId, invoiceId], references: [orgId, id])

  // Optional association back to a Lead for traceability.
  leadId String?
  lead   Lead?   @relation(fields: [orgId, leadId], references: [orgId, id])

  description    String
  quantity       Int      @default(1)
  unitPriceCents Int
  amountCents    Int
  source         String?
  createdAt      DateTime @default(now())

  @@index([invoiceId])
  @@index([leadId])
  @@index([orgId, leadId])
  @@index([orgId, invoiceId])
}

model AuditLog {
  id          String   @id @default(cuid())
  orgId       String
  actorUserId String?
  /// The entity type affected (e.g. 'lead', 'invoice', 'pricing', etc.)
  entity      String
  /// Identifier of the record affected
  entityId    String?
  /// Name of the field that was changed (nullable for record-level actions)
  field       String?
  /// Previous value (JSON) before the change, if applicable
  oldValue    Json?
  /// New value (JSON) after the change, if applicable
  newValue    Json?
  /// Free-form reason or comment describing why the change was made
  reason      String?
  createdAt   DateTime @default(now())

  org Org @relation(fields: [orgId], references: [id])
}

enum Role {
  OWNER
  MANAGER
  STAFF
  PROVIDER
  ACCOUNTANT
}

enum LeadSource {
  COLD
  HOT
  RFP
  MANUAL_EMPLOYEE_REFERRAL
  MANUAL_EXISTING_CUSTOMER
  MANUAL_NEW_CUSTOMER
  MANUAL_OTHER
  /// System-generated leads imported from external sources like SAM.gov
  SYSTEM
  /// Employee referrals (for internal referral program)
  EMPLOYEE_REFERRAL
  /// Manually added leads not fitting other categories
  MANUAL
  /// Leads imported from Local Service Ads or other lead sources
  LSA
}

enum ValueType {
  RELATIONSHIP
  JOB
}

enum LedgerType {
  CONVERSION_FEE
  PACK_PURCHASE
}

// === RBAC (namespaced to avoid collision with your existing Role enum) ===

model RbacPermission {
  id          String   @id @default(cuid())
  code        String   @unique // e.g. "lead:create"
  description String?
  createdAt   DateTime @default(now())

  rolePerms RbacRolePermission[]
}

model RbacRole {
  id        String   @id @default(cuid())
  orgId     String?
  // ðŸ‘‡ keep the named relation to match Org.rbacRoles
  org       Org?     @relation("OrgRbacRoles", fields: [orgId], references: [id])
  name      String
  slug      String
  isSystem  Boolean  @default(false)
  createdAt DateTime @default(now())

  rolePerms RbacRolePermission[]
  userRoles RbacUserRole[]

  @@unique([orgId, slug])
}

model RbacRolePermission {
  roleId       String
  permissionId String

  role       RbacRole       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission RbacPermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model RbacUserRole {
  id     String  @id @default(cuid())
  userId String
  orgId  String?
  roleId String

  // ðŸ‘‡ named relations to match Org/User sides
  user User     @relation("UserRbacUserRoles", fields: [userId], references: [id], onDelete: Cascade)
  org  Org?     @relation("OrgRbacUserRoles", fields: [orgId], references: [id])
  role RbacRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, orgId])
}

/// ProviderConfig holds provider-level secrets and configuration separate from any organization.
/// These values are used for system integrations that the provider controls, such as SAM.gov or
/// Stripe secrets used when billing clients.  Only one row is typically used.  Use a simple
/// admin interface to update these values.
model ProviderConfig {
  id              String   @id @default(cuid())
  samApiKey       String?
  stripeSecretKey String?
  otherConfig     Json?    @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

/// PricingPlan defines how an organization is billed for leads. Each org can have only
/// one pricing plan record. A plan specifies the billing model (e.g. per-lead fixed fee)
/// and can include tiered structures or prepaid units via includedUnits and tiersJson.
model PricingPlan {
  // We keep FK as primary key to enforce 1:1 with Org
  orgId String @id
  /// Relation to organization (named to match Org.pricingPlan)
  org   Org    @relation("OrgPricingPlan", fields: [orgId], references: [id])

  /// Billing model used for this organization (per-lead, tiered, subscription, or hybrid)
  model         PricingModel @default(PER_LEAD_FIXED)
  /// ISO currency code (e.g. "usd")
  currency      String       @default("usd")
  /// Fixed unit price in cents for per-lead billing
  unitAmount    Int          @default(10000)
  /// JSON-encoded pricing tiers (used when model is TIERED or HYBRID)
  tiersJson     Json?
  /// Number of prepaid leads included before billing starts
  includedUnits Int          @default(0)
}

/// PricingModel enumerates the possible billing models for lead invoices.  The default is
/// PER_LEAD_FIXED which charges a flat fee per converted lead.  Additional models support
/// tiered pricing, subscription (monthly base fee), or hybrid structures.
enum PricingModel {
  PER_LEAD_FIXED
  TIERED
  SUBSCRIPTION
  HYBRID
}

/// LeadStatus defines the possible states of a lead in the CRM pipeline.
/// Tracks the complete journey from initial contact to final outcome.
enum LeadStatus {
  NEW                 // Initial lead, no contact made
  CONTACTED          // Initial contact made (call, email, etc.)
  QUALIFIED          // Lead shows interest and has budget/authority/need/timeline
  MEETING_SCHEDULED  // Meeting or call scheduled
  PROPOSAL_SENT      // Proposal or quote sent to prospect
  NEGOTIATION        // In negotiations, discussing terms
  WON                // Lead converted to customer (billable)
  CONVERTED          // Legacy status - equivalent to WON (backward compatibility)
  LOST               // Lead didn't convert, deal closed unsuccessfully
  NURTURING          // Lead not ready now but staying in touch for future
  FOLLOW_UP          // Requires follow-up action
  ON_HOLD            // Lead temporarily paused
  UNRESPONSIVE       // Lead not responding to communications
}

/// ActivityType defines the different types of interactions and communications
/// that can be logged for lead management and CRM tracking.
enum ActivityType {
  CALL_OUTBOUND      // Outbound phone call
  CALL_INBOUND       // Inbound phone call received  
  EMAIL_SENT         // Email sent to lead
  EMAIL_RECEIVED     // Email received from lead
  MEETING_SCHEDULED  // Meeting or appointment scheduled
  MEETING_COMPLETED  // Meeting or appointment completed
  PROPOSAL_SENT      // Proposal or quote sent
  CONTRACT_SENT      // Contract sent for signature
  FOLLOW_UP          // General follow-up activity
  NOTE               // Internal note or comment
  TASK_CREATED       // Task created for lead
  TASK_COMPLETED     // Task completed for lead
  STATUS_CHANGED     // Lead status changed
  DOCUMENT_SHARED    // Document or file shared
  PAYMENT_RECEIVED   // Payment received from customer
}

/// LeadActivity tracks all interactions, communications, and events
/// related to a specific lead for complete CRM functionality.
model LeadActivity {
  id          String       @id @default(cuid())
  leadId      String
  orgId       String
  userId      String       // User who performed the activity
  
  type        ActivityType
  title       String       // Brief title/summary of activity
  description String?      // Detailed description or notes
  
  // Scheduling fields for meetings and calls
  scheduledAt DateTime?    // When the activity is scheduled
  completedAt DateTime?    // When the activity was completed
  
  // Contact information for calls/emails
  contactMethod String?    // Phone, email, in-person, etc.
  duration      Int?       // Duration in minutes for calls/meetings
  
  // File attachments and links
  attachments   Json?      // Array of file references or URLs
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Relations
  lead        Lead         @relation("LeadActivities", fields: [orgId, leadId], references: [orgId, id], onDelete: Cascade)
  org         Org          @relation("OrgLeadActivities", fields: [orgId], references: [id])
  user        User         @relation("UserLeadActivities", fields: [orgId, userId], references: [orgId, id])
  
  @@index([leadId, createdAt])
  @@index([orgId, type])
  @@index([userId, createdAt])
}

/// LeadTask manages scheduled tasks, reminders, and follow-ups
/// for lead management and CRM workflow automation.
model LeadTask {
  id          String       @id @default(cuid())
  leadId      String
  orgId       String
  assignedTo  String       // User assigned to complete the task
  createdBy   String       // User who created the task
  
  title       String       // Task title
  description String?      // Task description or notes
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(PENDING)
  
  // Scheduling
  dueDate     DateTime?    // When task is due
  completedAt DateTime?    // When task was completed
  
  // Reminders
  reminderAt  DateTime?    // When to send reminder
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Relations
  lead        Lead         @relation("LeadTasks", fields: [orgId, leadId], references: [orgId, id], onDelete: Cascade)
  org         Org          @relation("OrgLeadTasks", fields: [orgId], references: [id])
  assignee    User         @relation("AssignedLeadTasks", fields: [orgId, assignedTo], references: [orgId, id])
  creator     User         @relation("CreatedLeadTasks", fields: [orgId, createdBy], references: [orgId, id])
  
  @@index([leadId, status])
  @@index([assignedTo, dueDate])
  @@index([orgId, status])
}

/// TaskPriority defines urgency levels for lead tasks and follow-ups
enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

/// TaskStatus tracks the completion state of lead tasks
enum TaskStatus {
  PENDING     // Task not yet started
  IN_PROGRESS // Task currently being worked on
  COMPLETED   // Task finished successfully
  CANCELLED   // Task cancelled or no longer needed
  OVERDUE     // Task past due date
}

// AI Plan Tiers for Monetization - CLIENT SUBSCRIPTION TIERS
enum AiPlan {
  BASE    // MVP: Free lead generation, $100/conversion only
  PRO     // $97/month: Advanced AI, unlimited leads, priority support  
  ELITE   // $297/month: Market intelligence, priority RFPs, dedicated support
}

// Individual AI API call tracking for cost monitoring and analytics
model AiUsageEvent {
  id          String   @id @default(cuid())
  orgId       String
  userId      String?  // Optional user who triggered the call
  feature     String   // 'lead_analysis', 'rfp_strategy', 'pricing', 'response_gen'
  model       String   // 'gpt-4o-mini', etc
  tokensIn    Int      // Input tokens consumed
  tokensOut   Int      // Output tokens generated
  costUsd     Decimal  @db.Decimal(8, 6)  // Actual cost in USD (precise to $0.000001)
  creditsUsed Int      // Credits deducted from user's balance
  requestId   String?  // For request correlation and debugging
  createdAt   DateTime @default(now())

  org Org @relation("OrgAiUsageEvents", fields: [orgId], references: [id])

  @@index([orgId, createdAt])
  @@index([orgId, feature])
}

// Monthly AI usage rollups for dashboard and billing
model AiMonthlySummary {
  id          String   @id @default(cuid()) 
  orgId       String
  monthKey    String   // Format: "2025-01" for January 2025
  tokensIn    Int      @default(0)
  tokensOut   Int      @default(0)
  costUsd     Decimal  @db.Decimal(8, 2)  @default(0)
  creditsUsed Int      @default(0)
  callCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  org Org @relation("OrgAiMonthlySummaries", fields: [orgId], references: [id])

  @@unique([orgId, monthKey])
  @@index([monthKey])
}

// ===== MULTI-PORTAL BUSINESS OPERATING SYSTEM MODELS =====

/// EmployeeProfile extends User model with employee-specific data and ADP integration
model EmployeeProfile {
  id          String   @id @default(cuid())
  orgId       String
  userId      String   @unique // One-to-one with User
  
  // ADP Integration
  adpWorkerId String?  // ADP employee ID for payroll integration
  managerId   String?  // Reports to (User.id)
  
  // Mobile & Field Settings
  mobilePrefs Json     @default("{}")  // Mobile app preferences
  
  // Contact & Emergency Info
  emergencyContact Json? // Emergency contact information
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  org         Org           @relation("OrgEmployeeProfiles", fields: [orgId], references: [id])
  user        User          @relation("UserEmployeeProfile", fields: [orgId, userId], references: [orgId, id])
  timesheets  TimesheetEntry[] @relation("EmployeeTimesheets")
  jobAssignments JobAssignment[] @relation("EmployeeAssignments")
  issueReports IssueReport[] @relation("EmployeeIssueReports")
  trainingCompletions TrainingCompletion[] @relation("EmployeeTrainingCompletions")
  
  @@unique([orgId, id])  // Multi-tenant isolation
  @@unique([orgId, userId])  // One-to-one relation constraint
  @@index([orgId, adpWorkerId])
  @@index([userId])
}

/// WorkOrder represents enhanced work orders and customer projects (extended Job functionality)
model WorkOrder {
  id          String   @id @default(cuid())
  orgId       String
  customerId  String?
  
  // Work Order Details
  title       String
  description String?
  status      JobStatus @default(SCHEDULED)
  priority    JobPriority @default(MEDIUM)
  
  // Scheduling
  scheduledStartAt DateTime?
  scheduledEndAt   DateTime?
  actualStartAt    DateTime?
  actualEndAt      DateTime?
  
  // Location & Site Info
  jobSiteId   String?
  
  // Financial
  estimatedValue Decimal? @db.Decimal(12, 2)
  actualCost     Decimal? @db.Decimal(12, 2)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  org           Org             @relation("OrgWorkOrders", fields: [orgId], references: [id])
  customer      Customer?       @relation("CustomerWorkOrders", fields: [orgId, customerId], references: [orgId, id])
  jobSite       JobSite?        @relation("JobSiteWorkOrders", fields: [orgId, jobSiteId], references: [orgId, id])
  assignments   JobAssignment[] @relation("WorkOrderAssignments")
  checklists    JobChecklistItem[] @relation("WorkOrderChecklists")
  timesheets    TimesheetEntry[] @relation("WorkOrderTimesheets")
  issueReports  IssueReport[]   @relation("WorkOrderIssueReports")
  mediaAssets   MediaAsset[]    @relation("WorkOrderMedia")
  
  @@unique([orgId, id])  // Multi-tenant isolation
  @@index([orgId, status])
  @@index([customerId])
  @@index([scheduledStartAt])
}

/// JobSite defines geographic locations for geofenced time tracking
model JobSite {
  id          String   @id @default(cuid())
  orgId       String
  
  // Location Info
  name        String
  address     String
  city        String?
  state       String?
  zipCode     String?
  
  // Geofencing for time tracking
  latitude    Decimal? @db.Decimal(10, 8)  // GPS coordinates
  longitude   Decimal? @db.Decimal(11, 8)
  radiusMeters Int     @default(100)       // Geofence radius
  
  // Site Details
  accessInstructions String?
  emergencyContacts  Json?    @default("[]")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  org         Org      @relation("OrgJobSites", fields: [orgId], references: [id])
  workOrders  WorkOrder[] @relation("JobSiteWorkOrders")
  timesheets  TimesheetEntry[] @relation("JobSiteTimesheets")
  
  @@unique([orgId, id])  // Multi-tenant isolation
  @@index([orgId])
  @@index([latitude, longitude])
}

/// JobAssignment links employees to specific jobs with roles
model JobAssignment {
  id          String   @id @default(cuid())
  orgId       String
  jobId       String
  employeeId  String   // EmployeeProfile.id
  
  role        String   @default("worker")  // "lead", "worker", "supervisor"
  assignedAt  DateTime @default(now())
  unassignedAt DateTime?
  
  // Relations
  org         Org             @relation("OrgJobAssignments", fields: [orgId], references: [id])
  workOrder   WorkOrder       @relation("WorkOrderAssignments", fields: [orgId, jobId], references: [orgId, id])
  employee    EmployeeProfile @relation("EmployeeAssignments", fields: [orgId, employeeId], references: [orgId, id])
  
  @@unique([jobId, employeeId])
  @@index([orgId, employeeId])
  @@index([jobId])
}

/// TimesheetEntry tracks employee time with geolocation for job costing
model TimesheetEntry {
  id          String   @id @default(cuid())
  orgId       String
  employeeId  String   // EmployeeProfile.id
  jobId       String?  // Optional job association
  jobSiteId   String?  // Optional site association
  
  // Time Tracking
  clockInAt   DateTime
  clockOutAt  DateTime?
  breakMinutes Int     @default(0)
  
  // Geolocation Data
  clockInLat  Decimal? @db.Decimal(10, 8)
  clockInLng  Decimal? @db.Decimal(11, 8)
  clockOutLat Decimal? @db.Decimal(10, 8)
  clockOutLng Decimal? @db.Decimal(11, 8)
  
  // Device & Verification
  deviceInfo  Json?    // Device fingerprint for fraud prevention
  notes       String?
  status      TimesheetStatus @default(ACTIVE)
  
  // Approval Workflow
  approvedBy  String?  // User.id who approved
  approvedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  org         Org             @relation("OrgTimesheets", fields: [orgId], references: [id])
  employee    EmployeeProfile @relation("EmployeeTimesheets", fields: [orgId, employeeId], references: [orgId, id])
  workOrder   WorkOrder?      @relation("WorkOrderTimesheets", fields: [orgId, jobId], references: [orgId, id])
  jobSite     JobSite?        @relation("JobSiteTimesheets", fields: [orgId, jobSiteId], references: [orgId, id])
  
  @@index([orgId, employeeId, clockInAt])
  @@index([jobId])
  @@index([clockInAt])
}

/// JobChecklistItem tracks completion of job tasks with photo documentation
model JobChecklistItem {
  id          String   @id @default(cuid())
  orgId       String
  jobId       String
  
  // Checklist Item
  title       String
  description String?
  required    Boolean  @default(false)
  sortOrder   Int      @default(0)
  
  // Completion Tracking
  status      ChecklistStatus @default(PENDING)
  completedBy String?  // EmployeeProfile.id
  completedAt DateTime?
  notes       String?
  photosCount Int      @default(0)  // Number of associated photos
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  org         Org          @relation("OrgJobChecklists", fields: [orgId], references: [id])
  workOrder   WorkOrder    @relation("WorkOrderChecklists", fields: [orgId, jobId], references: [orgId, id])
  mediaAssets MediaAsset[] @relation("ChecklistMedia")
  
  @@unique([orgId, id])  // Multi-tenant isolation
  @@index([orgId, jobId])
  @@index([status])
}

/// IssueReport tracks field problems and obstacles with photo documentation
model IssueReport {
  id          String      @id @default(cuid())
  orgId       String
  jobId       String?     // Optional job association
  reportedBy  String      // EmployeeProfile.id
  
  // Issue Details
  title       String
  description String
  severity    IssueSeverity @default(MEDIUM)
  category    String?     // "equipment", "site_access", "weather", etc.
  
  // Resolution Tracking
  status      IssueStatus @default(OPEN)
  resolvedBy  String?     // User.id who resolved
  resolvedAt  DateTime?
  resolution  String?
  
  // Location Context
  latitude    Decimal?    @db.Decimal(10, 8)
  longitude   Decimal?    @db.Decimal(11, 8)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  org         Org             @relation("OrgIssueReports", fields: [orgId], references: [id])
  workOrder   WorkOrder?      @relation("WorkOrderIssueReports", fields: [orgId, jobId], references: [orgId, id])
  reporter    EmployeeProfile @relation("EmployeeIssueReports", fields: [orgId, reportedBy], references: [orgId, id])
  mediaAssets MediaAsset[]    @relation("IssueMedia")
  
  @@unique([orgId, id])  // Multi-tenant isolation
  @@index([orgId, status])
  @@index([jobId])
  @@index([reportedBy])
}

/// MediaAsset stores photos, videos, and documents with metadata
model MediaAsset {
  id          String    @id @default(cuid())
  orgId       String
  uploadedBy  String    // User.id
  
  // File Information
  filename    String
  originalName String
  contentType String
  fileSize    Int       // Bytes
  url         String    // S3/R2 URL
  thumbnailUrl String?  // Thumbnail URL for images
  
  // Asset Context (explicit foreign keys instead of polymorphic)
  assetType   MediaType
  workOrderId String?   // Optional WorkOrder reference
  issueReportId String? // Optional IssueReport reference
  checklistItemId String? // Optional JobChecklistItem reference
  trainingModuleId String? // Optional TrainingModule reference
  
  // Metadata
  exifJson    Json?     @default("{}")  // EXIF data for photos
  description String?
  tags        String[]  @default([])
  
  // Geolocation (if available)
  latitude    Decimal?  @db.Decimal(10, 8)
  longitude   Decimal?  @db.Decimal(11, 8)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations (explicit FKs instead of polymorphic)
  org         Org                @relation("OrgMediaAssets", fields: [orgId], references: [id])
  workOrder   WorkOrder?         @relation("WorkOrderMedia", fields: [orgId, workOrderId], references: [orgId, id])
  issueReport IssueReport?       @relation("IssueMedia", fields: [orgId, issueReportId], references: [orgId, id])
  checklistItem JobChecklistItem? @relation("ChecklistMedia", fields: [orgId, checklistItemId], references: [orgId, id])
  trainingModule TrainingModule?  @relation("TrainingMedia", fields: [orgId, trainingModuleId], references: [orgId, id])
  
  @@index([orgId, workOrderId])
  @@index([orgId, issueReportId])
  @@index([orgId, checklistItemId])
  @@index([orgId, trainingModuleId])
  @@index([uploadedBy])
  @@index([createdAt])
}

/// TrainingModule defines HR training requirements and content
model TrainingModule {
  id            String   @id @default(cuid())
  orgId         String
  
  // Module Information
  title         String
  description   String?
  content       String?  // Training content/instructions
  
  // Requirements
  requiredForRoles String[] @default([])  // Array of Role enum values
  isActive      Boolean  @default(true)
  version       String   @default("1.0")
  
  // Completion Settings
  requiresQuiz  Boolean  @default(false)
  passingScore  Int?     // Minimum score to pass (if quiz required)
  validityDays  Int?     // Days before retraining required
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  org           Org                @relation("OrgTrainingModules", fields: [orgId], references: [id])
  completions   TrainingCompletion[] @relation("ModuleCompletions")
  mediaAssets   MediaAsset[]       @relation("TrainingMedia")
  
  @@unique([orgId, id])  // Multi-tenant isolation
  @@index([orgId, isActive])
  @@index([requiredForRoles])
}

/// TrainingCompletion tracks employee training completion and compliance
model TrainingCompletion {
  id          String   @id @default(cuid())
  orgId       String
  employeeId  String   // EmployeeProfile.id
  moduleId    String
  
  // Completion Data
  completedAt DateTime @default(now())
  score       Int?     // Quiz score (if applicable)
  passed      Boolean  @default(true)
  
  // Validity
  expiresAt   DateTime? // When retraining is required
  isValid     Boolean  @default(true)
  
  // Metadata
  timeSpentMinutes Int? // Time spent on training
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  org         Org             @relation("OrgTrainingCompletions", fields: [orgId], references: [id])
  employee    EmployeeProfile @relation("EmployeeTrainingCompletions", fields: [orgId, employeeId], references: [orgId, id])
  module      TrainingModule  @relation("ModuleCompletions", fields: [orgId, moduleId], references: [orgId, id])
  
  @@unique([employeeId, moduleId]) // One completion per employee per module
  @@index([orgId, isValid])
  @@index([expiresAt])
}

// ===== ENUM DEFINITIONS FOR NEW MODELS =====

enum JobStatus {
  SCHEDULED   // Job scheduled but not started
  IN_PROGRESS // Job currently being worked
  ON_HOLD     // Job temporarily paused
  COMPLETED   // Job finished successfully
  CANCELLED   // Job cancelled before completion
}

enum JobPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TimesheetStatus {
  ACTIVE      // Currently clocked in
  COMPLETED   // Clocked out
  PENDING     // Awaiting approval
  APPROVED    // Approved by manager
  REJECTED    // Rejected for correction
}

enum ChecklistStatus {
  PENDING     // Not yet completed
  IN_PROGRESS // Partially completed
  COMPLETED   // Fully completed
  SKIPPED     // Marked as not applicable
}

enum IssueSeverity {
  LOW         // Minor issue, doesn't block work
  MEDIUM      // Moderate issue, may impact schedule
  HIGH        // Major issue, blocks current work
  CRITICAL    // Safety or emergency issue
}

enum IssueStatus {
  OPEN        // Issue reported, needs attention
  IN_PROGRESS // Being worked on
  RESOLVED    // Issue fixed
  CLOSED      // Issue closed without resolution
}

enum MediaType {
  PHOTO       // Images (JPEG, PNG, etc.)
  VIDEO       // Video files
  DOCUMENT    // PDFs, Word docs, etc.
  AUDIO       // Audio recordings
  OTHER       // Other file types
}
